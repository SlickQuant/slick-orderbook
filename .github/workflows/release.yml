name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:

jobs:
  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog

    - name: Get Version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Extract Changelog
      id: changelog
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"

        # Extract the section for this version from CHANGELOG.md
        awk -v version="$VERSION" '
          /^## \[/ {
            if (found) exit;
            if ($0 ~ "\\[" version "\\]") {
              found=1;
              next;
            }
          }
          found && /^## \[/ { exit }
          found { print }
        ' CHANGELOG.md > RELEASE_NOTES.md

        # If extraction failed or file is empty, use a default message
        if [ ! -s RELEASE_NOTES.md ]; then
          echo "Release version $VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "See [CHANGELOG.md](https://github.com/SlickQuant/slick-orderbook/blob/main/CHANGELOG.md) for details." >> RELEASE_NOTES.md
        fi

        # Add header
        sed -i '1i# Release Notes\n' RELEASE_NOTES.md

        echo "Release notes:"
        cat RELEASE_NOTES.md

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false

  # ============================================================================
  # Build Release Artifacts - Linux
  # ============================================================================
  build-linux:
    needs: create-release
    runs-on: ubuntu-24.04
    permissions:
      contents: write  # Required for uploading release assets
    strategy:
      matrix:
        arch: [x64]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc-14 g++-14

    - name: Install vcpkg Dependencies
      run: |
        vcpkg install nlohmann-json openssl boost-beast jwt-cpp

    - name: Build Release Package
      run: |
        VERSION=${{ needs.create-release.outputs.version }}
        cmake -B build -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++-14 \
          -DSLICK_ORDERBOOK_BUILD_TESTS=OFF \
          -DSLICK_ORDERBOOK_BUILD_EXAMPLES=ON \
          -DSLICK_ORDERBOOK_BUILD_BENCHMARKS=OFF

        cmake --build build -j $(nproc)

        # Create installation
        cmake --install build --prefix install

        # Package
        tar -czf slick-orderbook-${VERSION}-linux-${{ matrix.arch }}.tar.gz -C install .

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.create-release.outputs.version }}
        files: slick-orderbook-${{ needs.create-release.outputs.version }}-linux-${{ matrix.arch }}.tar.gz

  # ============================================================================
  # Build Release Artifacts - Windows
  # ============================================================================
  build-windows:
    needs: create-release
    runs-on: windows-2022
    permissions:
      contents: write  # Required for uploading release assets

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install vcpkg dependencies
      run: |
        vcpkg install nlohmann-json:x64-windows openssl:x64-windows boost-beast:x64-windows jwt-cpp:x64-windows

    - name: Build Release Package
      run: |
        $VERSION = "${{ needs.create-release.outputs.version }}"
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_BUILD_TYPE=Release `
          -DSLICK_ORDERBOOK_BUILD_TESTS=OFF `
          -DSLICK_ORDERBOOK_BUILD_EXAMPLES=ON `
          -DSLICK_ORDERBOOK_BUILD_BENCHMARKS=OFF

        cmake --build build --config Release -j

        # Create installation
        cmake --install build --prefix install --config Release

        # Package
        Compress-Archive -Path install\* -DestinationPath "slick-orderbook-${VERSION}-windows-x64.zip"

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.create-release.outputs.version }}
        files: slick-orderbook-${{ needs.create-release.outputs.version }}-windows-x64.zip

  # ============================================================================
  # Build Release Artifacts - macOS
  # ============================================================================
  build-macos:
    needs: create-release
    runs-on: macos-14
    permissions:
      contents: write  # Required for uploading release assets

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'

    - name: Install System Dependencies
      run: brew install cmake ninja

    - name: Install vcpkg Dependencies
      run: |
        vcpkg install nlohmann-json openssl boost-beast jwt-cpp

    - name: Build Release Package
      run: |
        VERSION=${{ needs.create-release.outputs.version }}
        cmake -B build -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" \
          -DCMAKE_BUILD_TYPE=Release \
          -DSLICK_ORDERBOOK_BUILD_TESTS=OFF \
          -DSLICK_ORDERBOOK_BUILD_EXAMPLES=ON \
          -DSLICK_ORDERBOOK_BUILD_BENCHMARKS=OFF

        cmake --build build -j $(sysctl -n hw.ncpu)

        # Create installation
        cmake --install build --prefix install

        # Package
        tar -czf slick-orderbook-${VERSION}-macos-arm64.tar.gz -C install .

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.create-release.outputs.version }}
        files: slick-orderbook-${{ needs.create-release.outputs.version }}-macos-arm64.tar.gz

  # ============================================================================
  # Publish Documentation
  # ============================================================================
  publish-docs:
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for uploading release assets

    steps:
    - uses: actions/checkout@v4

    - name: Create Documentation Archive
      run: |
        VERSION=${{ needs.create-release.outputs.version }}
        tar -czf slick-orderbook-${VERSION}-docs.tar.gz \
          README.md ARCHITECTURE.md CHANGELOG.md LICENSE \
          docs/ examples/ benchmarks/PROFILING_GUIDE.md

    - name: Upload Documentation
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.create-release.outputs.version }}
        files: slick-orderbook-${{ needs.create-release.outputs.version }}-docs.tar.gz
